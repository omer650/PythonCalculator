stages:
  - test
  - build
  - push

variables:
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: "/certs"
  ARTIFACTORY_URL: "http://artifactory:8082"
  ARTIFACTORY_REPO: "docker-local"
  IMAGE_NAME: "calculator-app"

# Test stage - runs on all branches and merge requests
test:
  stage: test
  image: python:3.11-slim
  before_script:
    - pip install --no-cache-dir -r requirements.txt
  script:
    - echo "Running tests..."
    - python -m pytest test_calculator.py -v
    - echo "✅ All tests passed!"
  only:
    - branches
    - merge_requests

# Build stage - builds Docker image
build:
  stage: build
  image: docker:24-dind
  services:
    - docker:24-dind
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - echo "Building Docker image..."
    - docker build -t $CI_REGISTRY_IMAGE:$CI_COMMIT_REF_SLUG -t $CI_REGISTRY_IMAGE:latest .
    - echo "Pushing to GitLab Container Registry..."
    - docker push $CI_REGISTRY_IMAGE:$CI_COMMIT_REF_SLUG
    - docker push $CI_REGISTRY_IMAGE:latest
    - echo "✅ Image built and pushed to GitLab registry!"
  only:
    - branches
    - tags

# Push to Artifactory stage - pushes to Artifactory OSS
push:artifactory:
  stage: push
  image: docker:24-dind
  services:
    - docker:24-dind
  variables:
    ARTIFACTORY_FULL_URL: "${ARTIFACTORY_URL}/${ARTIFACTORY_REPO}/${IMAGE_NAME}"
  before_script:
    - |
      if [ -z "$ARTIFACTORY_USERNAME" ] || [ -z "$ARTIFACTORY_PASSWORD" ]; then
        echo "⚠️  Artifactory credentials not set. Skipping Artifactory push."
        exit 0
      fi
    - echo "Logging into Artifactory..."
    - echo "$ARTIFACTORY_PASSWORD" | docker login -u "$ARTIFACTORY_USERNAME" --password-stdin "$ARTIFACTORY_URL"
  script:
    - echo "Tagging image for Artifactory..."
    - docker pull $CI_REGISTRY_IMAGE:latest
    - docker tag $CI_REGISTRY_IMAGE:latest $ARTIFACTORY_FULL_URL:$CI_COMMIT_REF_SLUG
    - docker tag $CI_REGISTRY_IMAGE:latest $ARTIFACTORY_FULL_URL:latest
    - echo "Pushing to Artifactory..."
    - docker push $ARTIFACTORY_FULL_URL:$CI_COMMIT_REF_SLUG
    - docker push $ARTIFACTORY_FULL_URL:latest
    - echo "✅ Image pushed to Artifactory!"
    - echo "Image available at: $ARTIFACTORY_FULL_URL:latest"
  only:
    - branches
    - tags
  when: manual
  allow_failure: true
