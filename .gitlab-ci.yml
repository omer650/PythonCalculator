stages:
  - test
  - build
  - push

variables:
  # Docker-in-Docker (DinD) configuration
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: "/certs"
  # Artifactory configuration (uses internal Docker network name)
  ARTIFACTORY_URL: "http://artifactory:8082"
  ARTIFACTORY_REPO: "docker-local"
  IMAGE_NAME: "calculator-app"

# Test stage - runs on all branches and merge requests
test:
  stage: test
  image: python:3.11-slim
  before_script:
    - pip install --no-cache-dir -r requirements.txt
  script:
    - echo "Running tests..."
    - python -m pytest test_calculator.py -v
    - echo "✅ All tests passed!"
  only:
    - branches
    - merge_requests

# Build stage - builds Docker image using Docker-in-Docker
build:
  stage: build
  # Use Docker-in-Docker image to build Docker images inside CI job
  image: docker:24-dind
  services:
    # DinD service provides isolated Docker daemon for building images
    - docker:24-dind
  before_script:
    # Login to GitLab Container Registry (credentials auto-provided by GitLab)
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - echo "Building Docker image..."
    # Build image with branch/tag name and latest tag
    - docker build -t $CI_REGISTRY_IMAGE:$CI_COMMIT_REF_SLUG -t $CI_REGISTRY_IMAGE:latest .
    - echo "Pushing to GitLab Container Registry..."
    # Push both tags to GitLab's built-in container registry
    - docker push $CI_REGISTRY_IMAGE:$CI_COMMIT_REF_SLUG
    - docker push $CI_REGISTRY_IMAGE:latest
    - echo "✅ Image built and pushed to GitLab registry!"
  only:
    - branches
    - tags

# Push to Artifactory stage - pushes to Artifactory OSS (optional)
deploy_artifactory:
  stage: push
  image: docker:24-dind
  services:
    - docker:24-dind
  variables:
    # Construct full Artifactory image URL
    ARTIFACTORY_FULL_URL: "${ARTIFACTORY_URL}/${ARTIFACTORY_REPO}/${IMAGE_NAME}"
  before_script:
    # Check if Artifactory credentials are configured (optional step)
    - |
      if [ -z "$ARTIFACTORY_USERNAME" ] || [ -z "$ARTIFACTORY_PASSWORD" ]; then
        echo "⚠️  Artifactory credentials not set. Skipping Artifactory push."
        exit 0
      fi
    - echo "Logging into Artifactory..."
    - echo "$ARTIFACTORY_PASSWORD" | docker login -u "$ARTIFACTORY_USERNAME" --password-stdin "$ARTIFACTORY_URL"
  script:
    - echo "Tagging image for Artifactory..."
    - docker pull $CI_REGISTRY_IMAGE:latest
    - docker tag $CI_REGISTRY_IMAGE:latest $ARTIFACTORY_FULL_URL:$CI_COMMIT_REF_SLUG
    - docker tag $CI_REGISTRY_IMAGE:latest $ARTIFACTORY_FULL_URL:latest
    - echo "Pushing to Artifactory..."
    - docker push $ARTIFACTORY_FULL_URL:$CI_COMMIT_REF_SLUG
    - docker push $ARTIFACTORY_FULL_URL:latest
    - echo "✅ Image pushed to Artifactory!"
    - echo "Image available at: $ARTIFACTORY_FULL_URL:latest"
  only:
    - branches
    - tags
  # Manual stage - must be triggered from GitLab UI
  when: manual
  # Allow pipeline to succeed even if this step fails (optional step)
  allow_failure: true
